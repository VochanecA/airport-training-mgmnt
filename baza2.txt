-- Training Management Database Schema
-- Reorganized script with correct table order and dependencies

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- LEVEL 1: Base tables (no foreign key dependencies)
-- ============================================================================

-- Training certificate types (base reference table)
CREATE TABLE public.training_certificate_types (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  category character varying,
  validity_period_months integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certificate_types_pkey PRIMARY KEY (id)
);

-- Training types (base reference table)
CREATE TABLE public.training_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  training_type character varying CHECK (training_type::text = ANY (ARRAY['initial'::character varying, 'recurrent'::character varying, 're_qualification'::character varying, 'update'::character varying, 'ojt'::character varying, 'refresher'::character varying, 'conversion'::character varying]::text[])),
  category character varying CHECK (category::text = ANY (ARRAY['safety'::character varying, 'technical'::character varying, 'operational'::character varying, 'administrative'::character varying, 'customer_service'::character varying, 'management'::character varying]::text[])),
  hours_initial_theory numeric,
  hours_initial_practical numeric,
  hours_initial_ojt numeric,
  hours_initial_total numeric,
  hours_recurrent_theory numeric,
  hours_recurrent_practical numeric,
  hours_recurrent_ojt numeric,
  hours_recurrent_total numeric,
  hours_re_qualification_theory numeric,
  hours_re_qualification_practical numeric,
  hours_re_qualification_ojt numeric,
  hours_re_qualification_total numeric,
  hours_update_theory numeric,
  hours_update_practical numeric,
  hours_update_ojt numeric,
  hours_update_total numeric,
  hours_ojt_theory numeric,
  hours_ojt_practical numeric,
  hours_ojt_total numeric,
  validity_period_months numeric,
  renewal_notice_days integer,
  is_mandatory boolean DEFAULT true,
  difficulty_level character varying CHECK (difficulty_level::text = ANY (ARRAY['basic'::character varying, 'intermediate'::character varying, 'advanced'::character varying, 'expert'::character varying]::text[])),
  reference_standard character varying,
  passing_score integer CHECK (passing_score >= 0 AND passing_score <= 100),
  requires_practical boolean DEFAULT false,
  requires_written_exam boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_types_pkey PRIMARY KEY (id)
);

-- Working positions (base reference table)
CREATE TABLE public.working_positions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  department character varying,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT working_positions_pkey PRIMARY KEY (id)
);

-- ============================================================================
-- LEVEL 2: Tables with single-level dependencies
-- ============================================================================

-- Training certificates master (depends on training_certificate_types)
CREATE TABLE public.training_certificates_master (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  type_id uuid,
  code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  training_provider character varying,
  duration_hours numeric,
  validity_months integer,
  renewal_before_days integer DEFAULT 30,
  is_mandatory boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certificates_master_pkey PRIMARY KEY (id),
  CONSTRAINT training_certificates_master_type_id_fkey FOREIGN KEY (type_id) REFERENCES public.training_certificate_types(id)
);

-- Staff (depends on working_positions)
CREATE TABLE public.staff (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  employee_number character varying NOT NULL UNIQUE,
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  email character varying UNIQUE,
  phone character varying,
  position_id uuid,
  staff_type character varying DEFAULT 'employee'::character varying,
  status character varying DEFAULT 'active'::character varying,
  hire_date date,
  termination_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT staff_pkey PRIMARY KEY (id),
  CONSTRAINT staff_position_id_fkey FOREIGN KEY (position_id) REFERENCES public.working_positions(id)
);

-- Trainings (depends on training_types)
CREATE TABLE public.trainings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  training_type_id uuid,
  title character varying NOT NULL,
  description text,
  instructor character varying,
  location character varying,
  start_date timestamp with time zone NOT NULL,
  end_date timestamp with time zone NOT NULL,
  capacity integer,
  status character varying DEFAULT 'scheduled'::character varying,
  training_hours_theory numeric,
  training_hours_practical numeric,
  training_hours_ojt numeric,
  training_hours_total numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trainings_pkey PRIMARY KEY (id),
  CONSTRAINT trainings_training_type_id_fkey FOREIGN KEY (training_type_id) REFERENCES public.training_types(id)
);

-- ============================================================================
-- LEVEL 3: Tables with dependencies on Level 2 tables
-- ============================================================================

-- Instructors (depends on staff)
CREATE TABLE public.instructors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  staff_id uuid,
  instructor_code character varying UNIQUE,
  specializations text[],
  certification_number character varying,
  certification_expiry date,
  status character varying DEFAULT 'active'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT instructors_pkey PRIMARY KEY (id),
  CONSTRAINT instructors_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id)
);

-- Courses (depends on training_certificates_master)
CREATE TABLE public.courses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  course_code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  course_type character varying NOT NULL,
  training_master_id uuid,
  start_date date NOT NULL,
  end_date date NOT NULL,
  location character varying,
  max_attendees integer,
  cost numeric,
  currency character varying DEFAULT 'EUR'::character varying,
  status character varying DEFAULT 'planned'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT courses_pkey PRIMARY KEY (id),
  CONSTRAINT courses_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id)
);

-- Position required training (depends on working_positions and training_certificates_master)
CREATE TABLE public.position_required_training (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  position_id uuid,
  training_master_id uuid,
  is_mandatory boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT position_required_training_pkey PRIMARY KEY (id),
  CONSTRAINT position_required_training_position_id_fkey FOREIGN KEY (position_id) REFERENCES public.working_positions(id),
  CONSTRAINT position_required_training_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id)
);

-- Training certificate records (depends on staff and training_certificates_master)
CREATE TABLE public.training_certificate_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  staff_id uuid,
  training_master_id uuid,
  certificate_number character varying,
  issue_date date NOT NULL,
  expiry_date date,
  completion_date date,
  grade character varying,
  notes text,
  training_provider character varying,
  instructor_name character varying,
  status character varying DEFAULT 'valid'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certificate_records_pkey PRIMARY KEY (id),
  CONSTRAINT training_certificate_records_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id),
  CONSTRAINT training_certificate_records_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id)
);

-- Training alerts (depends on staff and training_certificates_master)
CREATE TABLE public.training_alerts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  staff_id uuid,
  training_master_id uuid,
  alert_type character varying NOT NULL,
  alert_date date NOT NULL,
  expiry_date date,
  days_until_expiry integer,
  is_acknowledged boolean DEFAULT false,
  acknowledged_at timestamp with time zone,
  acknowledged_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT training_alerts_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id),
  CONSTRAINT training_alerts_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id),
  CONSTRAINT training_alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES public.staff(id)
);

-- ============================================================================
-- LEVEL 4: Tables with dependencies on Level 3 tables
-- ============================================================================

-- Course instructors (depends on courses and instructors)
CREATE TABLE public.course_instructors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  course_id uuid,
  instructor_id uuid,
  role character varying DEFAULT 'primary'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT course_instructors_pkey PRIMARY KEY (id),
  CONSTRAINT course_instructors_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id),
  CONSTRAINT course_instructors_instructor_id_fkey FOREIGN KEY (instructor_id) REFERENCES public.instructors(id)
);

-- Course attendees (depends on courses and staff)
CREATE TABLE public.course_attendees (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  course_id uuid,
  staff_id uuid,
  enrollment_date timestamp with time zone DEFAULT now(),
  attendance_status character varying DEFAULT 'enrolled'::character varying,
  completion_status character varying,
  grade character varying,
  certificate_issued boolean DEFAULT false,
  certificate_number character varying,
  certificate_issue_date date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT course_attendees_pkey PRIMARY KEY (id),
  CONSTRAINT course_attendees_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id),
  CONSTRAINT course_attendees_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id)
);

-- ============================================================================
-- Indexes for better performance (optional but recommended)
-- ============================================================================

-- Indexes on foreign keys
CREATE INDEX idx_staff_position_id ON public.staff(position_id);
CREATE INDEX idx_instructors_staff_id ON public.instructors(staff_id);
CREATE INDEX idx_courses_training_master_id ON public.courses(training_master_id);
CREATE INDEX idx_course_attendees_course_id ON public.course_attendees(course_id);
CREATE INDEX idx_course_attendees_staff_id ON public.course_attendees(staff_id);
CREATE INDEX idx_course_instructors_course_id ON public.course_instructors(course_id);
CREATE INDEX idx_course_instructors_instructor_id ON public.course_instructors(instructor_id);
CREATE INDEX idx_training_alerts_staff_id ON public.training_alerts(staff_id);
CREATE INDEX idx_training_certificate_records_staff_id ON public.training_certificate_records(staff_id);

-- Indexes on commonly queried fields
CREATE INDEX idx_staff_status ON public.staff(status);
CREATE INDEX idx_staff_employee_number ON public.staff(employee_number);
CREATE INDEX idx_courses_status ON public.courses(status);
CREATE INDEX idx_courses_start_date ON public.courses(start_date);
CREATE INDEX idx_training_alerts_alert_date ON public.training_alerts(alert_date);
CREATE INDEX idx_training_alerts_is_acknowledged ON public.training_alerts(is_acknowledged);

-- ============================================================================
-- Comments (optional - for documentation)
-- ============================================================================

COMMENT ON TABLE public.training_certificate_types IS 'Master list of training certificate type categories';
COMMENT ON TABLE public.training_types IS 'Defines different types of training programs with their requirements';
COMMENT ON TABLE public.working_positions IS 'Job positions within the organization';
COMMENT ON TABLE public.staff IS 'Employee and staff member records';
COMMENT ON TABLE public.instructors IS 'Certified instructors who can deliver training';
COMMENT ON TABLE public.courses IS 'Scheduled training courses and sessions';
COMMENT ON TABLE public.training_certificates_master IS 'Master catalog of available training certificates';
COMMENT ON TABLE public.course_attendees IS 'Staff members enrolled in or attending courses';
COMMENT ON TABLE public.training_certificate_records IS 'Individual training certificates issued to staff';
COMMENT ON TABLE public.training_alerts IS 'Notifications for expiring or required training';


-- Opcija 1: Promijeni foreign key da pokazuje na training_types
ALTER TABLE position_required_training 
  DROP CONSTRAINT position_required_training_training_master_id_fkey;

ALTER TABLE position_required_training 
  ADD CONSTRAINT position_required_training_training_master_id_fkey 
  FOREIGN KEY (training_master_id) 
  REFERENCES training_types(id);

-- Opcija 2: Dodaj novu kolonu training_type_id
ALTER TABLE position_required_training 
  ADD COLUMN training_type_id uuid REFERENCES training_types(id);



ALTER TABLE public.training_certificate_records 
ADD COLUMN issued_by character varying;

training_records_implementation.sql
-- ============================================================================
-- IMPLEMENTACIJA 8.2 RECORDS IDENTIFICATION
-- All theoretical, practical, on-the-job training documentation
-- ============================================================================

-- Enable UUID extension (ako već nije omogućeno)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- STEP 1: Create main training_records table
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.training_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  
  -- 8.2.a Trainee name and unique id number
  staff_id uuid NOT NULL,
  
  -- 8.2.b Subject/title of training
  training_title character varying NOT NULL,
  training_type_id uuid,
  training_master_id uuid,
  
  -- 8.2.c Training date and validity
  training_date date NOT NULL,
  training_end_date date,
  validity_months integer,
  expiry_date date,
  
  -- 8.2.d Competency achieved
  competency_achieved boolean DEFAULT false,
  competency_level character varying,
  competency_notes text,
  
  -- 8.2.e Passing score
  passing_score integer,
  actual_score numeric,
  score_type character varying,
  
  -- 8.2.f Name of trainer
  trainer_id uuid,
  trainer_name character varying,
  
  -- 8.2.g & 8.2.h Signatures (when paper-based)
  trainer_signature_date date,
  trainee_signature_date date,
  signature_notes text,
  has_paper_signatures boolean DEFAULT false,
  
  -- Additional completion fields
  training_hours_theory numeric DEFAULT 0,
  training_hours_practical numeric DEFAULT 0,
  training_hours_ojt numeric DEFAULT 0,
  training_hours_total numeric DEFAULT 0,
  
  training_method character varying CHECK (training_method IN (
    'classroom', 'online', 'ojt', 'practical', 'simulation', 'workshop', 'blended'
  )),
  
  location character varying,
  training_provider character varying,
  
  status character varying DEFAULT 'planned' CHECK (status IN (
    'planned', 'in_progress', 'completed', 'cancelled', 'failed'
  )),
  
  notes text,
  attachments text[],
  
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  
  -- Primary key and constraints
  CONSTRAINT training_records_pkey PRIMARY KEY (id),
  
  -- Foreign keys
  CONSTRAINT training_records_staff_id_fkey FOREIGN KEY (staff_id) 
    REFERENCES public.staff(id) ON DELETE CASCADE,
  CONSTRAINT training_records_training_type_id_fkey FOREIGN KEY (training_type_id) 
    REFERENCES public.training_types(id),
  CONSTRAINT training_records_training_master_id_fkey FOREIGN KEY (training_master_id) 
    REFERENCES public.training_certificates_master(id),
  CONSTRAINT training_records_trainer_id_fkey FOREIGN KEY (trainer_id) 
    REFERENCES public.instructors(id),
  CONSTRAINT training_records_created_by_fkey FOREIGN KEY (created_by) 
    REFERENCES public.staff(id),
  CONSTRAINT training_records_updated_by_fkey FOREIGN KEY (updated_by) 
    REFERENCES public.staff(id),
  
  -- Data validation
  CONSTRAINT training_records_valid_score CHECK (
    (score_type = 'percentage' AND actual_score BETWEEN 0 AND 100) OR
    (score_type = 'pass/fail' AND actual_score IN (0, 100)) OR
    (score_type = 'points' AND actual_score >= 0) OR
    (score_type IS NULL)
  ),
  CONSTRAINT training_records_valid_dates CHECK (
    training_end_date IS NULL OR training_end_date >= training_date
  ),
  CONSTRAINT training_records_valid_passing_score CHECK (
    passing_score IS NULL OR passing_score BETWEEN 0 AND 100
  )
);

COMMENT ON TABLE public.training_records IS 'Evidencija svih vrsta treninga (teorija, praksa, OJT) prema zahtjevima 8.2 Records Identification';

-- ============================================================================
-- STEP 2: Create function to calculate expiry date
-- ============================================================================

CREATE OR REPLACE FUNCTION public.calculate_training_expiry()
RETURNS TRIGGER AS $$
BEGIN
  -- Calculate expiry date based on validity months
  IF NEW.validity_months IS NOT NULL AND NEW.training_date IS NOT NULL THEN
    NEW.expiry_date := NEW.training_date + (NEW.validity_months || ' months')::interval;
  ELSE
    NEW.expiry_date := NULL;
  END IF;
  
  -- Auto-calculate total training hours
  IF NEW.training_hours_total IS NULL THEN
    NEW.training_hours_total := 
      COALESCE(NEW.training_hours_theory, 0) + 
      COALESCE(NEW.training_hours_practical, 0) + 
      COALESCE(NEW.training_hours_ojt, 0);
  END IF;
  
  -- Set paper signatures flag
  IF NEW.trainer_signature_date IS NOT NULL OR NEW.trainee_signature_date IS NOT NULL THEN
    NEW.has_paper_signatures := true;
  END IF;
  
  -- Auto-update updated_at timestamp
  NEW.updated_at := now();
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- STEP 3: Create trigger for expiry calculation
-- ============================================================================

DROP TRIGGER IF EXISTS trg_calculate_training_expiry ON public.training_records;
CREATE TRIGGER trg_calculate_training_expiry
  BEFORE INSERT OR UPDATE ON public.training_records
  FOR EACH ROW
  EXECUTE FUNCTION public.calculate_training_expiry();

-- ============================================================================
-- STEP 4: Create indexes for performance
-- ============================================================================

-- Foreign key indexes
CREATE INDEX IF NOT EXISTS idx_training_records_staff_id 
  ON public.training_records(staff_id);

CREATE INDEX IF NOT EXISTS idx_training_records_training_type_id 
  ON public.training_records(training_type_id);

CREATE INDEX IF NOT EXISTS idx_training_records_trainer_id 
  ON public.training_records(trainer_id);

CREATE INDEX IF NOT EXISTS idx_training_records_created_by 
  ON public.training_records(created_by);

-- Query optimization indexes
CREATE INDEX IF NOT EXISTS idx_training_records_training_date 
  ON public.training_records(training_date);

CREATE INDEX IF NOT EXISTS idx_training_records_expiry_date 
  ON public.training_records(expiry_date);

CREATE INDEX IF NOT EXISTS idx_training_records_status 
  ON public.training_records(status);

CREATE INDEX IF NOT EXISTS idx_training_records_competency_achieved 
  ON public.training_records(competency_achieved);

-- Composite indexes for common queries
CREATE INDEX IF NOT EXISTS idx_training_records_staff_status 
  ON public.training_records(staff_id, status);

CREATE INDEX IF NOT EXISTS idx_training_records_date_range 
  ON public.training_records(training_date, expiry_date);

-- ============================================================================
-- STEP 5: Create view for easy access to 8.2 required data
-- ============================================================================

CREATE OR REPLACE VIEW public.training_records_8_2_view AS
SELECT 
  -- 8.2.a Trainee name and unique id number
  s.employee_number AS "Trainee Unique ID",
  s.first_name || ' ' || s.last_name AS "Trainee Name",
  
  -- 8.2.b Subject/title of training
  tr.training_title AS "Training Subject/Title",
  tt.name AS "Training Type",
  
  -- 8.2.c Training date and validity
  tr.training_date AS "Training Date",
  tr.training_end_date AS "Training End Date",
  tr.validity_months AS "Validity Period (months)",
  tr.expiry_date AS "Expiry Date",
  
  -- 8.2.d Competency achieved
  tr.competency_achieved AS "Competency Achieved",
  tr.competency_level AS "Competency Level",
  
  -- 8.2.e Passing score
  tr.passing_score AS "Passing Score (%)",
  tr.actual_score AS "Actual Score",
  tr.score_type AS "Score Type",
  
  -- 8.2.f Name of trainer
  COALESCE(
    i_staff.first_name || ' ' || i_staff.last_name,
    tr.trainer_name
  ) AS "Trainer Name",
  
  -- Signatures (8.2.g & 8.2.h)
  tr.trainer_signature_date AS "Trainer Signature Date",
  tr.trainee_signature_date AS "Trainee Signature Date",
  tr.has_paper_signatures AS "Has Paper Signatures",
  
  -- Additional useful information
  tr.training_method AS "Training Method",
  tr.location AS "Location",
  tr.training_provider AS "Training Provider",
  tr.training_hours_theory AS "Theory Hours",
  tr.training_hours_practical AS "Practical Hours",
  tr.training_hours_ojt AS "OJT Hours",
  tr.training_hours_total AS "Total Hours",
  tr.status AS "Status",
  tr.notes AS "Notes",
  
  -- Metadata
  tr.created_at AS "Record Created",
  tr.updated_at AS "Last Updated"
  
FROM public.training_records tr
LEFT JOIN public.staff s ON tr.staff_id = s.id
LEFT JOIN public.training_types tt ON tr.training_type_id = tt.id
LEFT JOIN public.instructors i ON tr.trainer_id = i.id
LEFT JOIN public.staff i_staff ON i.staff_id = i_staff.id
WHERE tr.status IN ('completed', 'in_progress')
ORDER BY tr.training_date DESC;

COMMENT ON VIEW public.training_records_8_2_view IS 'View containing all data required by 8.2 Records Identification';

-- ============================================================================
-- STEP 6: Create function to check if training is valid/expired
-- ============================================================================

CREATE OR REPLACE FUNCTION public.get_training_status_info(
  p_training_record_id uuid
)
RETURNS TABLE(
  record_id uuid,
  staff_name text,
  training_title text,
  training_date date,
  expiry_date date,
  is_valid boolean,
  days_until_expiry integer,
  status text
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    tr.id,
    s.first_name || ' ' || s.last_name,
    tr.training_title,
    tr.training_date,
    tr.expiry_date,
    CASE 
      WHEN tr.expiry_date IS NULL THEN true
      WHEN tr.expiry_date >= CURRENT_DATE THEN true
      ELSE false
    END AS is_valid,
    CASE 
      WHEN tr.expiry_date IS NULL THEN NULL
      ELSE tr.expiry_date - CURRENT_DATE
    END AS days_until_expiry,
    tr.status
  FROM public.training_records tr
  JOIN public.staff s ON tr.staff_id = s.id
  WHERE tr.id = p_training_record_id;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- STEP 7: Create audit table for tracking changes (optional but recommended)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.training_records_audit (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  training_record_id uuid NOT NULL,
  changed_by uuid,
  changed_at timestamp with time zone DEFAULT now(),
  change_type varchar(20) CHECK (change_type IN ('CREATE', 'UPDATE', 'DELETE')),
  field_name varchar(100),
  old_value text,
  new_value text,
  
  CONSTRAINT training_records_audit_pkey PRIMARY KEY (id),
  CONSTRAINT training_records_audit_training_record_id_fkey 
    FOREIGN KEY (training_record_id) 
    REFERENCES public.training_records(id) ON DELETE CASCADE,
  CONSTRAINT training_records_audit_changed_by_fkey 
    FOREIGN KEY (changed_by) 
    REFERENCES public.staff(id)
);

CREATE INDEX IF NOT EXISTS idx_training_audit_record_id 
  ON public.training_records_audit(training_record_id);

CREATE INDEX IF NOT EXISTS idx_training_audit_changed_at 
  ON public.training_records_audit(changed_at);

-- ============================================================================
-- STEP 8: Create trigger for audit logging
-- ============================================================================

CREATE OR REPLACE FUNCTION public.log_training_record_changes()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO public.training_records_audit 
      (training_record_id, change_type, changed_by)
    VALUES (NEW.id, 'CREATE', NEW.created_by);
    
  ELSIF TG_OP = 'UPDATE' THEN
    INSERT INTO public.training_records_audit 
      (training_record_id, change_type, changed_by, field_name, old_value, new_value)
    SELECT 
      NEW.id,
      'UPDATE',
      NEW.updated_by,
      key,
      old_val,
      new_val
    FROM jsonb_each_text(to_jsonb(OLD)) AS old_data(key, old_val)
    JOIN jsonb_each_text(to_jsonb(NEW)) AS new_data(key, new_val)
    ON old_data.key = new_data.key
    WHERE old_data.value IS DISTINCT FROM new_data.value;
    
  ELSIF TG_OP = 'DELETE' THEN
    INSERT INTO public.training_records_audit 
      (training_record_id, change_type)
    VALUES (OLD.id, 'DELETE');
  END IF;
  
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_audit_training_records ON public.training_records;
CREATE TRIGGER trg_audit_training_records
  AFTER INSERT OR UPDATE OR DELETE ON public.training_records
  FOR EACH ROW
  EXECUTE FUNCTION public.log_training_record_changes();

-- ============================================================================
-- STEP 9: Create function to generate training summary report
-- ============================================================================

CREATE OR REPLACE FUNCTION public.generate_training_summary_report(
  p_start_date date DEFAULT NULL,
  p_end_date date DEFAULT NULL,
  p_department varchar DEFAULT NULL
)
RETURNS TABLE(
  employee_number varchar,
  employee_name text,
  position varchar,
  total_trainings bigint,
  completed_trainings bigint,
  total_hours numeric,
  avg_score numeric,
  competencies_achieved bigint
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    s.employee_number,
    s.first_name || ' ' || s.last_name AS employee_name,
    wp.title AS position,
    COUNT(tr.id) AS total_trainings,
    COUNT(CASE WHEN tr.status = 'completed' THEN 1 END) AS completed_trainings,
    COALESCE(SUM(tr.training_hours_total), 0) AS total_hours,
    AVG(tr.actual_score) FILTER (WHERE tr.score_type = 'percentage') AS avg_score,
    COUNT(CASE WHEN tr.competency_achieved = true THEN 1 END) AS competencies_achieved
  FROM public.staff s
  LEFT JOIN public.working_positions wp ON s.position_id = wp.id
  LEFT JOIN public.training_records tr ON s.id = tr.staff_id
    AND (p_start_date IS NULL OR tr.training_date >= p_start_date)
    AND (p_end_date IS NULL OR tr.training_date <= p_end_date)
  WHERE p_department IS NULL OR wp.department = p_department
    AND s.status = 'active'
  GROUP BY s.id, s.employee_number, s.first_name, s.last_name, wp.title
  ORDER BY s.last_name, s.first_name;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- STEP 10: Create function to get expiring trainings
-- ============================================================================

CREATE OR REPLACE FUNCTION public.get_expiring_trainings(
  p_days_threshold integer DEFAULT 30
)
RETURNS TABLE(
  record_id uuid,
  staff_name text,
  training_title text,
  expiry_date date,
  days_remaining integer,
  staff_email varchar
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    tr.id,
    s.first_name || ' ' || s.last_name AS staff_name,
    tr.training_title,
    tr.expiry_date,
    tr.expiry_date - CURRENT_DATE AS days_remaining,
    s.email
  FROM public.training_records tr
  JOIN public.staff s ON tr.staff_id = s.id
  WHERE tr.status = 'completed'
    AND tr.expiry_date IS NOT NULL
    AND tr.expiry_date >= CURRENT_DATE
    AND tr.expiry_date <= CURRENT_DATE + (p_days_threshold || ' days')::interval
  ORDER BY tr.expiry_date;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- SUCCESS MESSAGE
-- ============================================================================

DO $$ 
BEGIN
  RAISE NOTICE '============================================';
  RAISE NOTICE '8.2 RECORDS IDENTIFICATION IMPLEMENTED';
  RAISE NOTICE '============================================';
  RAISE NOTICE 'Created: training_records table';
  RAISE NOTICE 'Created: training_records_audit table';
  RAISE NOTICE 'Created: calculate_training_expiry trigger';
  RAISE NOTICE 'Created: log_training_record_changes trigger';
  RAISE NOTICE 'Created: 9 performance indexes';
  RAISE NOTICE 'Created: training_records_8_2_view view';
  RAISE NOTICE 'Created: 3 utility functions';
  RAISE NOTICE '============================================';
END $$;






  ***NOVA KOMPLET***
  -- Training Management Database Schema
-- Complete script with all tables and dependencies including modifications for position_required_training

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- LEVEL 1: Base tables (no foreign key dependencies)
-- ============================================================================

-- Training certificate types (base reference table)
CREATE TABLE public.training_certificate_types (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  category character varying,
  validity_period_months integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certificate_types_pkey PRIMARY KEY (id)
);

-- Training types (base reference table)
CREATE TABLE public.training_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  description text,
  training_type character varying CHECK (training_type::text = ANY (ARRAY['initial'::character varying, 'recurrent'::character varying, 're_qualification'::character varying, 'update'::character varying, 'ojt'::character varying, 'refresher'::character varying, 'conversion'::character varying]::text[])),
  category character varying CHECK (category::text = ANY (ARRAY['safety'::character varying, 'technical'::character varying, 'operational'::character varying, 'administrative'::character varying, 'customer_service'::character varying, 'management'::character varying]::text[])),
  hours_initial_theory numeric,
  hours_initial_practical numeric,
  hours_initial_ojt numeric,
  hours_initial_total numeric,
  hours_recurrent_theory numeric,
  hours_recurrent_practical numeric,
  hours_recurrent_ojt numeric,
  hours_recurrent_total numeric,
  hours_re_qualification_theory numeric,
  hours_re_qualification_practical numeric,
  hours_re_qualification_ojt numeric,
  hours_re_qualification_total numeric,
  hours_update_theory numeric,
  hours_update_practical numeric,
  hours_update_ojt numeric,
  hours_update_total numeric,
  hours_ojt_theory numeric,
  hours_ojt_practical numeric,
  hours_ojt_total numeric,
  validity_period_months numeric,
  renewal_notice_days integer,
  is_mandatory boolean DEFAULT true,
  difficulty_level character varying CHECK (difficulty_level::text = ANY (ARRAY['basic'::character varying, 'intermediate'::character varying, 'advanced'::character varying, 'expert'::character varying]::text[])),
  reference_standard character varying,
  passing_score integer CHECK (passing_score >= 0 AND passing_score <= 100),
  requires_practical boolean DEFAULT false,
  requires_written_exam boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_types_pkey PRIMARY KEY (id)
);

-- Working positions (base reference table)
CREATE TABLE public.working_positions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  department character varying,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT working_positions_pkey PRIMARY KEY (id)
);

-- ============================================================================
-- LEVEL 2: Tables with single-level dependencies
-- ============================================================================

-- Training certificates master (depends on training_certificate_types)
CREATE TABLE public.training_certificates_master (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  type_id uuid,
  code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  training_provider character varying,
  duration_hours numeric,
  validity_months integer,
  renewal_before_days integer DEFAULT 30,
  is_mandatory boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certificates_master_pkey PRIMARY KEY (id),
  CONSTRAINT training_certificates_master_type_id_fkey FOREIGN KEY (type_id) REFERENCES public.training_certificate_types(id)
);

-- Staff (depends on working_positions)
CREATE TABLE public.staff (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  employee_number character varying NOT NULL UNIQUE,
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  email character varying UNIQUE,
  phone character varying,
  position_id uuid,
  staff_type character varying DEFAULT 'employee'::character varying,
  status character varying DEFAULT 'active'::character varying,
  hire_date date,
  termination_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT staff_pkey PRIMARY KEY (id),
  CONSTRAINT staff_position_id_fkey FOREIGN KEY (position_id) REFERENCES public.working_positions(id)
);

-- Trainings (depends on training_types)
CREATE TABLE public.trainings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  training_type_id uuid,
  title character varying NOT NULL,
  description text,
  instructor character varying,
  location character varying,
  start_date timestamp with time zone NOT NULL,
  end_date timestamp with time zone NOT NULL,
  capacity integer,
  status character varying DEFAULT 'scheduled'::character varying,
  training_hours_theory numeric,
  training_hours_practical numeric,
  training_hours_ojt numeric,
  training_hours_total numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trainings_pkey PRIMARY KEY (id),
  CONSTRAINT trainings_training_type_id_fkey FOREIGN KEY (training_type_id) REFERENCES public.training_types(id)
);

-- ============================================================================
-- LEVEL 3: Tables with dependencies on Level 2 tables
-- ============================================================================

-- Instructors (depends on staff)
CREATE TABLE public.instructors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  staff_id uuid,
  instructor_code character varying UNIQUE,
  specializations text[],
  certification_number character varying,
  certification_expiry date,
  status character varying DEFAULT 'active'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT instructors_pkey PRIMARY KEY (id),
  CONSTRAINT instructors_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id)
);

-- Courses (depends on training_certificates_master)
CREATE TABLE public.courses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  course_code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  course_type character varying NOT NULL,
  training_master_id uuid,
  start_date date NOT NULL,
  end_date date NOT NULL,
  location character varying,
  max_attendees integer,
  cost numeric,
  currency character varying DEFAULT 'EUR'::character varying,
  status character varying DEFAULT 'planned'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT courses_pkey PRIMARY KEY (id),
  CONSTRAINT courses_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id)
);

-- Position required training (MODIFIED - now depends on working_positions and training_types)
CREATE TABLE public.position_required_training (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  position_id uuid,
  training_master_id uuid, -- OVO SADA REFERENCIRA training_types (nakon promjene)
  training_type_id uuid, -- DODATA NOVA KOLONA (Opcija 2)
  is_mandatory boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT position_required_training_pkey PRIMARY KEY (id),
  CONSTRAINT position_required_training_position_id_fkey FOREIGN KEY (position_id) REFERENCES public.working_positions(id),
  -- Promijenjena foreign key da pokazuje na training_types umjesto training_certificates_master
  CONSTRAINT position_required_training_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_types(id),
  -- Dodata foreign key za novu kolonu training_type_id
  CONSTRAINT position_required_training_training_type_id_fkey FOREIGN KEY (training_type_id) REFERENCES public.training_types(id)
);

-- Training certificate records (depends on staff and training_certificates_master)
CREATE TABLE public.training_certificate_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  staff_id uuid,
  training_master_id uuid,
  certificate_number character varying,
  issue_date date NOT NULL,
  expiry_date date,
  completion_date date,
  grade character varying,
  notes text,
  training_provider character varying,
  instructor_name character varying,
  status character varying DEFAULT 'valid'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_certificate_records_pkey PRIMARY KEY (id),
  CONSTRAINT training_certificate_records_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id),
  CONSTRAINT training_certificate_records_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id)
);

-- Training alerts (depends on staff and training_certificates_master)
CREATE TABLE public.training_alerts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  staff_id uuid,
  training_master_id uuid,
  alert_type character varying NOT NULL,
  alert_date date NOT NULL,
  expiry_date date,
  days_until_expiry integer,
  is_acknowledged boolean DEFAULT false,
  acknowledged_at timestamp with time zone,
  acknowledged_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT training_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT training_alerts_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id),
  CONSTRAINT training_alerts_training_master_id_fkey FOREIGN KEY (training_master_id) REFERENCES public.training_certificates_master(id),
  CONSTRAINT training_alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES public.staff(id)
);

-- ============================================================================
-- LEVEL 4: Tables with dependencies on Level 3 tables
-- ============================================================================

-- Course instructors (depends on courses and instructors)
CREATE TABLE public.course_instructors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  course_id uuid,
  instructor_id uuid,
  role character varying DEFAULT 'primary'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT course_instructors_pkey PRIMARY KEY (id),
  CONSTRAINT course_instructors_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id),
  CONSTRAINT course_instructors_instructor_id_fkey FOREIGN KEY (instructor_id) REFERENCES public.instructors(id)
);

-- Course attendees (depends on courses and staff)
CREATE TABLE public.course_attendees (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  course_id uuid,
  staff_id uuid,
  enrollment_date timestamp with time zone DEFAULT now(),
  attendance_status character varying DEFAULT 'enrolled'::character varying,
  completion_status character varying,
  grade character varying,
  certificate_issued boolean DEFAULT false,
  certificate_number character varying,
  certificate_issue_date date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT course_attendees_pkey PRIMARY KEY (id),
  CONSTRAINT course_attendees_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id),
  CONSTRAINT course_attendees_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id)
);

-- ============================================================================
-- Indexes for better performance (optional but recommended)
-- ============================================================================

-- Indexes on foreign keys
CREATE INDEX idx_staff_position_id ON public.staff(position_id);
CREATE INDEX idx_instructors_staff_id ON public.instructors(staff_id);
CREATE INDEX idx_courses_training_master_id ON public.courses(training_master_id);
CREATE INDEX idx_course_attendees_course_id ON public.course_attendees(course_id);
CREATE INDEX idx_course_attendees_staff_id ON public.course_attendees(staff_id);
CREATE INDEX idx_course_instructors_course_id ON public.course_instructors(course_id);
CREATE INDEX idx_course_instructors_instructor_id ON public.course_instructors(instructor_id);
CREATE INDEX idx_training_alerts_staff_id ON public.training_alerts(staff_id);
CREATE INDEX idx_training_certificate_records_staff_id ON public.training_certificate_records(staff_id);
CREATE INDEX idx_position_required_training_position_id ON public.position_required_training(position_id);
CREATE INDEX idx_position_required_training_training_master_id ON public.position_required_training(training_master_id);
CREATE INDEX idx_position_required_training_training_type_id ON public.position_required_training(training_type_id);

-- Indexes on commonly queried fields
CREATE INDEX idx_staff_status ON public.staff(status);
CREATE INDEX idx_staff_employee_number ON public.staff(employee_number);
CREATE INDEX idx_courses_status ON public.courses(status);
CREATE INDEX idx_courses_start_date ON public.courses(start_date);
CREATE INDEX idx_training_alerts_alert_date ON public.training_alerts(alert_date);
CREATE INDEX idx_training_alerts_is_acknowledged ON public.training_alerts(is_acknowledged);

-- ============================================================================
-- Comments (optional - for documentation)
-- ============================================================================

COMMENT ON TABLE public.training_certificate_types IS 'Master list of training certificate type categories';
COMMENT ON TABLE public.training_types IS 'Defines different types of training programs with their requirements';
COMMENT ON TABLE public.working_positions IS 'Job positions within the organization';
COMMENT ON TABLE public.staff IS 'Employee and staff member records';
COMMENT ON TABLE public.instructors IS 'Certified instructors who can deliver training';
COMMENT ON TABLE public.courses IS 'Scheduled training courses and sessions';
COMMENT ON TABLE public.training_certificates_master IS 'Master catalog of available training certificates';
COMMENT ON TABLE public.course_attendees IS 'Staff members enrolled in or attending courses';
COMMENT ON TABLE public.training_certificate_records IS 'Individual training certificates issued to staff';
COMMENT ON TABLE public.training_alerts IS 'Notifications for expiring or required training';
COMMENT ON TABLE public.position_required_training IS 'Training requirements for specific job positions (modified to reference training_types)';

-- ============================================================================
-- Optional: Create a view for position training requirements with details
-- ============================================================================

CREATE OR REPLACE VIEW public.position_training_requirements_view AS
SELECT 
  prt.id,
  prt.position_id,
  wp.title AS position_title,
  wp.department AS position_department,
  prt.training_master_id AS training_type_id,
  tt.code AS training_type_code,
  tt.name AS training_type_name,
  tt.category AS training_category,
  tt.training_type AS training_subtype,
  tt.validity_period_months,
  tt.is_mandatory AS training_type_mandatory,
  prt.training_type_id AS alt_training_type_id, -- alternative reference
  prt.is_mandatory AS position_requirement_mandatory,
  prt.created_at
FROM public.position_required_training prt
LEFT JOIN public.working_positions wp ON prt.position_id = wp.id
LEFT JOIN public.training_types tt ON prt.training_master_id = tt.id
WHERE wp.is_active = true AND tt.is_active = true;

COMMENT ON VIEW public.position_training_requirements_view IS 'View showing training requirements for each position with training type details';